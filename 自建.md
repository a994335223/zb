# è‡ªå»º P2P Web å³æ—¶é€šè®¯ç³»ç»Ÿ

> ğŸš€ ä¸€ä¸ªç®€æ´çš„ç‚¹å¯¹ç‚¹ Web å³æ—¶é€šè®¯æ–¹æ¡ˆï¼Œæ”¯æŒç¾¤èŠã€è¯­éŸ³ã€è§†é¢‘ç¾¤èŠ

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [æŠ€æœ¯æ ˆé€‰æ‹©](#æŠ€æœ¯æ ˆé€‰æ‹©)
4. [æ ¸å¿ƒåŠŸèƒ½è®¾è®¡](#æ ¸å¿ƒåŠŸèƒ½è®¾è®¡)
5. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
6. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
7. [è¯¦ç»†å®ç°æŒ‡å—](#è¯¦ç»†å®ç°æŒ‡å—)
8. [éƒ¨ç½²æ–¹æ¡ˆ](#éƒ¨ç½²æ–¹æ¡ˆ)

---

## é¡¹ç›®æ¦‚è¿°

### ç›®æ ‡

æ„å»ºä¸€ä¸ª**è½»é‡çº§ã€å…ä¸­å¿ƒæœåŠ¡å™¨**çš„å³æ—¶é€šè®¯ç³»ç»Ÿï¼š

| åŠŸèƒ½ | æè¿° |
|------|------|
| ğŸ’¬ æ–‡å­—èŠå¤© | æ”¯æŒç§èŠå’Œç¾¤èŠ |
| ğŸ¤ è¯­éŸ³é€šè¯ | æ”¯æŒä¸€å¯¹ä¸€å’Œç¾¤ç»„è¯­éŸ³ |
| ğŸ“¹ è§†é¢‘é€šè¯ | æ”¯æŒä¸€å¯¹ä¸€å’Œç¾¤ç»„è§†é¢‘ |
| ğŸ”’ ç«¯åˆ°ç«¯åŠ å¯† | æ•°æ®ä»…åœ¨é€šè¯åŒæ–¹ä¹‹é—´ä¼ è¾“ |
| ğŸŒ çº¯æµè§ˆå™¨ | æ— éœ€å®‰è£…ä»»ä½•å®¢æˆ·ç«¯ |

### æ ¸å¿ƒç†å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     P2P é€šä¿¡æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚     â”‚ ç”¨æˆ· A  â”‚â—„â•â•â•â•â•â•â• WebRTC â•â•â•â•â•â•â•â–ºâ”‚ ç”¨æˆ· B  â”‚        â”‚
â”‚     â”‚ (æµè§ˆå™¨) â”‚     ç›´æ¥P2Pè¿æ¥         â”‚ (æµè§ˆå™¨) â”‚        â”‚
â”‚     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â”‚
â”‚          â”‚                                    â”‚             â”‚
â”‚          â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚             â”‚
â”‚          â””â”€â”€â”€â–ºâ”‚   ä¿¡ä»¤æœåŠ¡å™¨(è½»é‡)   â”‚â—„â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚               â”‚  ä»…ç”¨äºå»ºç«‹è¿æ¥      â”‚                      â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                          â”‚                                  â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚               â–¼                      â–¼                      â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚        â”‚ STUN Server â”‚       â”‚ TURN Server â”‚               â”‚
â”‚        â”‚  (NATç©¿é€)   â”‚       â”‚  (ä¸­ç»§å¤‡ç”¨)  â”‚               â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… ä¼˜ç‚¹ï¼š
â€¢ æ•°æ®ç›´æ¥åœ¨ç”¨æˆ·ä¹‹é—´ä¼ è¾“ï¼ŒæœåŠ¡å™¨ä¸å­˜å‚¨ä»»ä½•èŠå¤©å†…å®¹
â€¢ ä¿¡ä»¤æœåŠ¡å™¨æå…¶è½»é‡ï¼Œä»…ç”¨äºäº¤æ¢è¿æ¥ä¿¡æ¯
â€¢ çœŸæ­£çš„ç«¯åˆ°ç«¯åŠ å¯†
```

---

## æŠ€æœ¯æ¶æ„

### STUN vs TURN æ ¸å¿ƒæ¦‚å¿µ

> ğŸ”‘ **å…³é”®ç†è§£**ï¼šè¿™å†³å®šäº†ä½ çš„æœåŠ¡å™¨æˆæœ¬ï¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STUN æ‰“æ´ï¼ˆä¸æ¶ˆè€—æœåŠ¡å™¨æµé‡ï¼‰                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·A â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–º ç”¨æˆ·B  â”‚
â”‚               ç›´æ¥P2Pä¼ è¾“ï¼Œè§†é¢‘ä¸ç»è¿‡ä»»ä½•æœåŠ¡å™¨                  â”‚
â”‚                                                                 â”‚
â”‚   STUNæœåŠ¡å™¨åªå¸®å¿™"ä»‹ç»è®¤è¯†"ï¼Œä¹‹åå°±ä¸å‚ä¸äº†                    â”‚
â”‚   ğŸ’° æµé‡æˆæœ¬ï¼šÂ¥0                                               â”‚
â”‚   ğŸ“Š æˆåŠŸç‡ï¼šçº¦70-80%ï¼ˆç®€å•NATç¯å¢ƒï¼‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TURN ä¸­ç»§ï¼ˆæ¶ˆè€—æœåŠ¡å™¨æµé‡ï¼ï¼‰                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ç”¨æˆ·A â”€â”€è§†é¢‘â”€â”€â–º TURNæœåŠ¡å™¨ â”€â”€è§†é¢‘â”€â”€â–º ç”¨æˆ·B                   â”‚
â”‚                                                                 â”‚
â”‚   æ‰€æœ‰è§†é¢‘æ•°æ®éƒ½ç»è¿‡æœåŠ¡å™¨è½¬å‘ï¼                                â”‚
â”‚   ğŸ’° æµé‡æˆæœ¬ï¼š1å°æ—¶720Pè§†é¢‘ â‰ˆ 1GBæµé‡                         â”‚
â”‚   ğŸ“Š ä½¿ç”¨åœºæ™¯ï¼šçº¦20-30%ï¼ˆå¤æ‚NAT/ä¼ä¸šç½‘ç»œï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| å¯¹æ¯” | STUN | TURN |
|------|------|------|
| **ä½œç”¨** | å¸®åŠ©å‘ç°å…¬ç½‘IPï¼ŒååŠ©æ‰“æ´ | ä¸­ç»§è½¬å‘æ‰€æœ‰æ•°æ® |
| **æ•°æ®æµå‘** | ç”¨æˆ·A â†” ç”¨æˆ·Bï¼ˆç›´è¿ï¼‰ | ç”¨æˆ·A â†’ æœåŠ¡å™¨ â†’ ç”¨æˆ·B |
| **æµé‡æ¶ˆè€—** | âŒ ä¸æ¶ˆè€— | âœ… æ¶ˆè€—æœåŠ¡å™¨å¸¦å®½ |
| **å…è´¹å…¬å…±** | âœ… æœ‰å¾ˆå¤š | âŒ å‡ ä¹æ²¡æœ‰ |
| **å¿…è¦æ€§** | å¿…é¡»æœ‰ | å¤‡ç”¨ï¼ˆP2På¤±è´¥æ—¶ï¼‰ |

### TURN æµé‡æˆæœ¬ä¼°ç®—

| è§†é¢‘è´¨é‡ | ç ç‡ | 1å°æ—¶æµé‡ | è¯´æ˜ |
|----------|------|----------|------|
| çº¯è¯­éŸ³ | 50Kbps | ~25MB | å‡ ä¹å…è´¹ |
| 480P | 1Mbps | ~500MB | ä½æˆæœ¬ |
| 720P | 2Mbps | ~1GB | ä¸­ç­‰ |
| 1080P | 4Mbps | ~2GB | è¾ƒé«˜ |

---

### ä¸‰ç§è§†é¢‘æ¶æ„è¯¦è§£

#### ğŸ•¸ï¸ Meshï¼ˆç½‘çŠ¶å…¨è¿æ¥ï¼‰

```
        4äººç¾¤èŠç¤ºä¾‹ï¼šæ¯äººç›´æ¥è¿æ¥å…¶ä»–3äºº
        
              ç”¨æˆ·A
             â•±  â”‚  â•²
            â•±   â”‚   â•²
        ç”¨æˆ·Bâ”€â”€â”€â”¼â”€â”€â”€ç”¨æˆ·C
            â•²   â”‚   â•±
             â•²  â”‚  â•±
              ç”¨æˆ·D

æ¯ä¸ªäººéœ€è¦ï¼šä¸Šä¼ 3ä»½è§†é¢‘ + ä¸‹è½½3ä»½è§†é¢‘
æœåŠ¡å™¨éœ€æ±‚ï¼šâŒ ä¸éœ€è¦ä¸­ç»§æœåŠ¡å™¨
```

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **åŸç†** | æ¯ä¸ªäººç›´æ¥P2Pè¿æ¥æ‰€æœ‰å…¶ä»–äºº |
| **ä¼˜ç‚¹** | å»¶è¿Ÿæœ€ä½ï¼Œä¸éœ€è¦æœåŠ¡å™¨ï¼Œæˆæœ¬æœ€ä½ |
| **ç¼ºç‚¹** | äººå¤šæ—¶å®¢æˆ·ç«¯å¸¦å®½å‹åŠ›å¤§ï¼ˆNäººéœ€N-1æ¡è¿æ¥ï¼‰ |
| **é€‚åˆ** | â‰¤6äºº å°ç¾¤ç»„ |
| **æˆæœ¬** | ğŸ’° æœ€ä½ï¼ˆåªéœ€STUNï¼‰ |

---

#### ğŸ“¡ SFUï¼ˆé€‰æ‹©æ€§è½¬å‘å•å…ƒï¼‰

```
        4äººç¾¤èŠç¤ºä¾‹ï¼šéƒ½è¿æ¥åˆ°SFUæœåŠ¡å™¨
        
              ç”¨æˆ·A
                â”‚
                â†“ ä¸Šä¼ 1ä»½
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   SFU   â”‚ â† æœåŠ¡å™¨åªè½¬å‘ï¼Œä¸å¤„ç†è§†é¢‘
           â”‚  æœåŠ¡å™¨  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†™   â†“   â†“   â†˜
        ç”¨æˆ·B  ç”¨æˆ·C  ç”¨æˆ·D  ï¼ˆæ¯äººä¸‹è½½3ä»½ï¼‰
        
æ¯ä¸ªäººéœ€è¦ï¼šä¸Šä¼ 1ä»½ï¼Œä¸‹è½½N-1ä»½
æœåŠ¡å™¨éœ€æ±‚ï¼šâœ… éœ€è¦ï¼ˆä½†åªè½¬å‘ä¸å¤„ç†ï¼‰
```

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **åŸç†** | æ¯äººä¸Šä¼ 1ä»½åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è½¬å‘ç»™å…¶ä»–äºº |
| **ä¼˜ç‚¹** | å®¢æˆ·ç«¯ä¸Šä¼ å‹åŠ›å°ï¼Œæ‰©å±•æ€§å¥½ |
| **ç¼ºç‚¹** | éœ€è¦æœåŠ¡å™¨ï¼Œæœ‰å¸¦å®½æˆæœ¬ |
| **é€‚åˆ** | 7-50äºº ä¸­å‹ç¾¤ç»„ |
| **æˆæœ¬** | ğŸ’° ä¸­ç­‰ï¼ˆæœåŠ¡å™¨å¸¦å®½è´¹ç”¨ï¼‰ |

---

#### ğŸ¬ MCUï¼ˆå¤šç‚¹æ§åˆ¶å•å…ƒï¼‰

```
        4äººç¾¤èŠç¤ºä¾‹ï¼šæœåŠ¡å™¨æ··åˆæˆä¸€ä¸ªç”»é¢
        
        ç”¨æˆ·A  ç”¨æˆ·B  ç”¨æˆ·C  ç”¨æˆ·D
          â”‚      â”‚      â”‚      â”‚
          â†“      â†“      â†“      â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         MCU            â”‚
        â”‚   æŠŠ4ä¸ªè§†é¢‘æ··æˆ1ä¸ªç”»é¢   â”‚  â† æœåŠ¡å™¨éœ€è¦è§£ç +ç¼–ç 
        â”‚   â”Œâ”€â”€â”¬â”€â”€â”              â”‚
        â”‚   â”‚A â”‚B â”‚              â”‚
        â”‚   â”œâ”€â”€â”¼â”€â”€â”¤              â”‚
        â”‚   â”‚C â”‚D â”‚              â”‚
        â”‚   â””â”€â”€â”´â”€â”€â”˜              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
          â†“       â†“       â†“
        æ‰€æœ‰äººæ”¶åˆ°åŒä¸€ä¸ªæ··åˆç”»é¢
        
æ¯ä¸ªäººéœ€è¦ï¼šä¸Šä¼ 1ä»½ï¼Œä¸‹è½½1ä»½ï¼ˆæ··åˆåçš„ï¼‰
æœåŠ¡å™¨éœ€æ±‚ï¼šâœ… éœ€è¦ï¼ˆä¸”éœ€è¦è§†é¢‘å¤„ç†èƒ½åŠ›ï¼‰
```

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **åŸç†** | æœåŠ¡å™¨æŠŠæ‰€æœ‰è§†é¢‘æ··åˆæˆä¸€ä¸ªç”»é¢å†å‘é€ |
| **ä¼˜ç‚¹** | å®¢æˆ·ç«¯å¸¦å®½å‹åŠ›æœ€å° |
| **ç¼ºç‚¹** | æœåŠ¡å™¨CPUå‹åŠ›æœ€å¤§ï¼Œå»¶è¿Ÿé«˜ï¼Œæˆæœ¬æœ€é«˜ |
| **é€‚åˆ** | 50+ äººå¤§å‹ä¼šè®® |
| **æˆæœ¬** | ğŸ’° æœ€é«˜ï¼ˆéœ€è¦é«˜æ€§èƒ½æœåŠ¡å™¨ï¼‰ |

---

### æ¶æ„å¯¹æ¯”æ€»ç»“

| æ¶æ„ | é€‚ç”¨äººæ•° | æœåŠ¡å™¨éœ€æ±‚ | æœåŠ¡å™¨å‹åŠ› | å»¶è¿Ÿ | æˆæœ¬ |
|------|----------|-----------|-----------|------|------|
| **Mesh** | â‰¤6äºº | âŒ ä¸éœ€è¦ | æ—  | â­æœ€ä½ | ğŸ’° æœ€ä½ |
| **SFU** | 7-50äºº | âœ… éœ€è¦ | ä¸­ç­‰(è½¬å‘) | â­â­ä½ | ğŸ’°ğŸ’° ä¸­ç­‰ |
| **MCU** | 50+äºº | âœ… éœ€è¦ | é«˜(å¤„ç†) | â­â­â­è¾ƒé«˜ | ğŸ’°ğŸ’°ğŸ’° æœ€é«˜ |

### æˆ‘ä»¬çš„æ–¹æ¡ˆï¼šMesh ä¼˜å…ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æˆ‘ä»¬çš„æœ€ä¼˜è·¯å¾„ï¼ˆçœé’±ï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   æ­¥éª¤1: STUNå¸®åŠ©æ‰“æ´                                           â”‚
â”‚          â†“                                                      â”‚
â”‚   æ­¥éª¤2: å°è¯• Mesh P2P ç›´è¿                                     â”‚
â”‚          â†“                                                      â”‚
â”‚   æˆåŠŸ â†’ ç”¨æˆ·A â†â•â•â•â• ç›´æ¥P2P â•â•â•â•â†’ ç”¨æˆ·B ï¼ˆä¸èŠ±é’±ï¼‰            â”‚
â”‚          â†“                                                      â”‚
â”‚   å¤±è´¥ â†’ ç”¨æˆ·A â”€â”€â†’ TURNä¸­ç»§ â”€â”€â†’ ç”¨æˆ·B ï¼ˆèŠ±é’±ï¼Œçº¦20%åœºæ™¯ï¼‰       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é€‚ç”¨åœºæ™¯ï¼šâ‰¤6äººå°ç¾¤ç»„
æˆæœ¬ä¼°ç®—ï¼š70-80%åœºæ™¯å…è´¹ï¼Œ20-30%åœºæ™¯éœ€è¦TURN
```

---

## æŠ€æœ¯æ ˆé€‰æ‹©

### å‰ç«¯

| æŠ€æœ¯ | ç”¨é€” | é€‰æ‹©ç†ç”± |
|------|------|---------|
| **Vue 3** | UI æ¡†æ¶ | Composition APIï¼Œå“åº”å¼å¼ºå¤§ï¼Œä¸­æ–‡ç”Ÿæ€å¥½ |
| **TypeScript** | ç±»å‹å®‰å…¨ | Vue3 åŸç”Ÿæ”¯æŒï¼Œç±»å‹æ¨å¯¼ä¼˜ç§€ |
| **Vite** | æ„å»ºå·¥å…· | Vue å®˜æ–¹æ¨èï¼Œæé€Ÿ HMR |
| **Pinia** | çŠ¶æ€ç®¡ç† | Vue å®˜æ–¹çŠ¶æ€ç®¡ç†ï¼Œæ›¿ä»£ Vuex |
| **Socket.io-client** | WebSocket | è‡ªåŠ¨é‡è¿ï¼Œæˆ¿é—´æ”¯æŒ |
| **simple-peer** | WebRTC å°è£… | ç®€åŒ– P2P å¼€å‘ï¼Œæ¡†æ¶æ— å…³ |
| **UnoCSS** | åŸå­åŒ–æ ·å¼ | æ¯” Tailwind æ›´è½»é‡ï¼Œå…¼å®¹ Tailwind è¯­æ³• |
| **Naive UI** | ç»„ä»¶åº“(å¯é€‰) | TypeScript å‹å¥½ï¼Œç°ä»£è®¾è®¡ |

### åç«¯

| æŠ€æœ¯ | ç”¨é€” | é€‰æ‹©ç†ç”± |
|------|------|---------|
| **Bun** | è¿è¡Œæ—¶ | åŸç”Ÿæ”¯æŒTSï¼Œå†…ç½®WebSocketï¼Œæ¯”Nodeå¿«4å€ |
| **Hono** | Web æ¡†æ¶ | è¶…è½»é‡(14KB)ï¼Œæ€§èƒ½æé«˜ï¼Œå¤šè¿è¡Œæ—¶æ”¯æŒ |
| **åŸç”ŸWebSocket** | ä¿¡ä»¤ä¼ è¾“ | Bunå†…ç½®ï¼Œæ— éœ€Socket.io |

> ğŸ’¡ **ä¸ºä»€ä¹ˆæ¢æ‰ Node.js + Expressï¼Ÿ**
> - Bun åŸç”Ÿæ”¯æŒ TypeScriptï¼Œé›¶é…ç½®
> - Bun å†…ç½® WebSocketï¼Œä¸éœ€è¦ Socket.io
> - Hono æ¯” Express å¿«4å€ï¼Œä½“ç§¯å°14å€
> - ä»£ç é‡å‡å°‘ 60%

### åŸºç¡€è®¾æ–½ï¼ˆä¸­å›½ä¼˜åŒ–ï¼‰

| ç»„ä»¶ | å¼€å‘é˜¶æ®µ | ç”Ÿäº§é˜¶æ®µ | è¯´æ˜ |
|------|---------|---------|------|
| **STUN** | å…¬å…±æœåŠ¡å™¨(å…è´¹) | è‡ªå»ºcoturn | å¼€å‘é›¶æˆæœ¬ |
| **TURN** | å¯é€‰(åŒç½‘ç»œä¸éœ€è¦) | è‡ªå»ºcoturn | ä»…P2På¤±è´¥æ—¶ä½¿ç”¨ |
| **éƒ¨ç½²** | æœ¬åœ°Bunè¿è¡Œ | Docker | ç”Ÿäº§ç¯å¢ƒå®¹å™¨åŒ– |
| **åå‘ä»£ç†** | ä¸éœ€è¦ | Nginx | HTTPS + WSS |

### ICEæœåŠ¡å™¨é…ç½®ï¼ˆä¸­å›½å¯ç”¨ï¼‰

```typescript
// src/config/ice.ts - ç»Ÿä¸€é…ç½®æ–‡ä»¶

const isDev = import.meta.env.DEV

export const iceServers = {
  iceServers: isDev 
    ? [
        // ========== å¼€å‘é˜¶æ®µï¼šä½¿ç”¨å…¬å…±STUNï¼ˆå…è´¹ï¼‰==========
        { urls: 'stun:stun.voipbuster.com:3478' },
        { urls: 'stun:stun.ekiga.net:3478' },
        { urls: 'stun:stun.schlund.de:3478' },
        { urls: 'stun:stun.sipgate.net:10000' },
      ]
    : [
        // ========== ç”Ÿäº§é˜¶æ®µï¼šä½¿ç”¨è‡ªå»ºæœåŠ¡å™¨ ==========
        { urls: 'stun:your-server.com:3478' },
        {
          urls: 'turn:your-server.com:3478',
          username: 'webrtc',
          credential: 'your_password',
        },
      ]
}
```

### å¼€å‘åˆ°ä¸Šçº¿æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ1: æœ¬åœ°å¼€å‘                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ä»£ç ä¸­é…ç½®å…¬å…±STUNæœåŠ¡å™¨                                      â”‚
â”‚  â€¢ æœ¬åœ°è¿è¡Œå‰åç«¯                                                â”‚
â”‚  â€¢ æµè§ˆå™¨æ‰“å¼€ä¸¤ä¸ªæ ‡ç­¾é¡µæµ‹è¯•                                      â”‚
â”‚  â€¢ æˆæœ¬ï¼šÂ¥0                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ2: å±€åŸŸç½‘æµ‹è¯•ï¼ˆç”µè„‘+æ‰‹æœºï¼‰                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ åŒæ ·ä½¿ç”¨å…¬å…±STUNé…ç½®                                          â”‚
â”‚  â€¢ æ‰‹æœºè®¿é—®ç”µè„‘å±€åŸŸç½‘IP: http://192.168.x.x:5173                 â”‚
â”‚  â€¢ æµ‹è¯•çœŸå®çš„åŒè®¾å¤‡é€šè¯                                          â”‚
â”‚  â€¢ æˆæœ¬ï¼šÂ¥0                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ3: è·¨ç½‘ç»œæµ‹è¯•                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ç”µè„‘è¿WiFiï¼Œæ‰‹æœºç”¨4Gï¼ˆä¸åŒç½‘ç»œï¼‰                              â”‚
â”‚  â€¢ åç«¯éœ€è¦éƒ¨ç½²åˆ°å…¬ç½‘æˆ–ä½¿ç”¨å†…ç½‘ç©¿é€                              â”‚
â”‚  â€¢ æµ‹è¯•å…¬å…±STUNèƒ½å¦æˆåŠŸæ‰“æ´                                      â”‚
â”‚  â€¢ æˆæœ¬ï¼šÂ¥0                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ4: æ­£å¼ä¸Šçº¿                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ è´­ä¹°äº‘æœåŠ¡å™¨ï¼Œéƒ¨ç½²åç«¯ + å‰ç«¯ + coturn                        â”‚
â”‚  â€¢ ä¿®æ”¹ç¯å¢ƒå˜é‡åˆ‡æ¢åˆ°ç”Ÿäº§é…ç½®                                    â”‚
â”‚  â€¢ é…ç½®åŸŸå + HTTPS                                              â”‚
â”‚  â€¢ æˆæœ¬ï¼šÂ¥24-50/æœˆèµ·                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| é˜¶æ®µ | STUN | TURN | åç«¯ | æˆæœ¬ |
|------|------|------|------|------|
| æœ¬åœ°å¼€å‘ | å…¬å…± | âŒ | æœ¬åœ° | Â¥0 |
| å±€åŸŸç½‘æµ‹è¯• | å…¬å…± | âŒ | æœ¬åœ° | Â¥0 |
| è·¨ç½‘ç»œæµ‹è¯• | å…¬å…± | âš ï¸å¯èƒ½ | å…¬ç½‘/ç©¿é€ | Â¥0 |
| æ­£å¼ä¸Šçº¿ | è‡ªå»º | âœ…è‡ªå»º | äº‘æœåŠ¡å™¨ | Â¥24+ |

### æˆæœ¬ä¼°ç®—

| é˜¶æ®µ | STUN/TURN | æœˆæˆæœ¬ | è¦†ç›–åœºæ™¯ |
|------|-----------|--------|---------|
| **å¼€å‘æµ‹è¯•** | å…¬å…±STUN | Â¥0 | ~70% |
| **å°è§„æ¨¡ä¸Šçº¿** | è‡ªå»ºcoturn (1æ ¸1G) | Â¥24-50 | ~95% |
| **æ­£å¼è¿è¥** | è‡ªå»ºcoturn (2æ ¸4G) | Â¥100-200 | ~99% |

### è‡ªå»º coturn æœåŠ¡å™¨è¦æ±‚

| è¦æ±‚ | è¯´æ˜ | é‡è¦æ€§ |
|------|------|--------|
| **å…¬ç½‘IP** | å¿…é¡»æœ‰ç‹¬ç«‹å…¬ç½‘IP | â­â­â­â­â­ å¿…é¡» |
| **UDPç«¯å£** | å¼€æ”¾ 3478 + 49152-65535 | â­â­â­â­â­ å¿…é¡» |
| **å¸¦å®½** | æŒ‰ç”¨æˆ·æ•°ï¼Œ1äººçº¦1-2Mbps | â­â­â­ æŒ‰éœ€ |
| **å†…å­˜/CPU** | 1æ ¸1Gè¶³å¤Ÿå°è§„æ¨¡ | â­â­ è¦æ±‚ä½ |
| **ç³»ç»Ÿ** | Linux (Ubuntuæ¨è) | â­â­ |

> âš ï¸ **è´­ä¹°æœåŠ¡å™¨æ³¨æ„**ï¼šé¿å…å…±äº«IPçš„è™šæ‹Ÿä¸»æœºã€NAT VPSï¼ˆæ²¡æœ‰ç‹¬ç«‹å…¬ç½‘IPï¼‰ã€ç«¯å£å—é™çš„æœåŠ¡å™¨

---

## æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 1. æˆ¿é—´ç³»ç»Ÿ

```typescript
// æˆ¿é—´ç±»å‹
interface Room {
  id: string;           // æˆ¿é—´ID (6ä½éšæœºç )
  name: string;         // æˆ¿é—´åç§°
  password?: string;    // å¯é€‰å¯†ç 
  creator: string;      // åˆ›å»ºè€…ID
  members: Member[];    // æˆå‘˜åˆ—è¡¨
  maxSize: number;      // æœ€å¤§äººæ•° (é»˜è®¤20)
  createdAt: Date;
}

interface Member {
  id: string;
  nickname: string;
  avatar?: string;
  isMuted: boolean;
  isVideoOff: boolean;
  joinedAt: Date;
}
```

### 2. ä¿¡ä»¤åè®®

```typescript
// ä¿¡ä»¤æ¶ˆæ¯ç±»å‹
type SignalType = 
  | 'join-room'      // åŠ å…¥æˆ¿é—´
  | 'leave-room'     // ç¦»å¼€æˆ¿é—´
  | 'offer'          // WebRTC Offer
  | 'answer'         // WebRTC Answer
  | 'ice-candidate'  // ICE å€™é€‰
  | 'chat-message'   // èŠå¤©æ¶ˆæ¯
  | 'user-joined'    // ç”¨æˆ·åŠ å…¥é€šçŸ¥
  | 'user-left'      // ç”¨æˆ·ç¦»å¼€é€šçŸ¥
  | 'mute-toggle'    // é™éŸ³åˆ‡æ¢
  | 'video-toggle';  // è§†é¢‘åˆ‡æ¢

interface SignalMessage {
  type: SignalType;
  from: string;
  to?: string;        // ç§èŠæ—¶æŒ‡å®š
  roomId: string;
  payload: any;
  timestamp: number;
}
```

### 3. WebRTC è¿æ¥ç®¡ç†

```typescript
// è¿æ¥çŠ¶æ€
interface PeerConnection {
  peerId: string;
  connection: RTCPeerConnection;
  dataChannel: RTCDataChannel;  // ç”¨äºæ–‡å­—èŠå¤©
  streams: {
    local: MediaStream | null;
    remote: MediaStream | null;
  };
  state: 'connecting' | 'connected' | 'disconnected' | 'failed';
}
```

---

## é¡¹ç›®ç»“æ„

```
p2p-chat/
â”œâ”€â”€ client/                    # å‰ç«¯é¡¹ç›® (Vue 3)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/        # Vue ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ chat/          # èŠå¤©ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ChatRoom.vue
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MessageList.vue
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MessageInput.vue
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ video/         # è§†é¢‘ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ VideoGrid.vue
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ VideoTile.vue
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Controls.vue
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ room/          # æˆ¿é—´ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CreateRoom.vue
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ JoinRoom.vue
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RoomInfo.vue
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â””â”€â”€ common/        # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”‚       â”œâ”€â”€ AppButton.vue
â”‚   â”‚   â”‚       â”œâ”€â”€ AppInput.vue
â”‚   â”‚   â”‚       â”œâ”€â”€ AppModal.vue
â”‚   â”‚   â”‚       â””â”€â”€ AppAvatar.vue
â”‚   â”‚   â”œâ”€â”€ composables/       # ç»„åˆå¼å‡½æ•° (Vue3 Hooks)
â”‚   â”‚   â”‚   â”œâ”€â”€ useWebRTC.ts   # WebRTC é€»è¾‘
â”‚   â”‚   â”‚   â”œâ”€â”€ useSocket.ts   # Socket è¿æ¥
â”‚   â”‚   â”‚   â”œâ”€â”€ useMediaStream.ts  # åª’ä½“æµç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ useRoom.ts     # æˆ¿é—´é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ stores/            # Pinia çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ room.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ user.ts
â”‚   â”‚   â”‚   â””â”€â”€ media.ts
â”‚   â”‚   â”œâ”€â”€ services/          # æœåŠ¡å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ socket.ts      # Socket.io å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ webrtc.ts      # WebRTC æœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ media.ts       # åª’ä½“è®¾å¤‡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ types/             # TypeScript ç±»å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ room.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ message.ts
â”‚   â”‚   â”‚   â””â”€â”€ signal.ts
â”‚   â”‚   â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â”œâ”€â”€ random.ts
â”‚   â”‚   â”‚   â””â”€â”€ time.ts
â”‚   â”‚   â”œâ”€â”€ views/             # é¡µé¢è§†å›¾
â”‚   â”‚   â”‚   â”œâ”€â”€ Home.vue
â”‚   â”‚   â”‚   â””â”€â”€ Room.vue
â”‚   â”‚   â”œâ”€â”€ router/            # Vue Router
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ App.vue
â”‚   â”‚   â”œâ”€â”€ main.ts
â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â”œâ”€â”€ uno.config.ts          # UnoCSS é…ç½®
â”‚   â””â”€â”€ env.d.ts
â”‚
â”œâ”€â”€ server/                    # åç«¯é¡¹ç›®
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.ts           # å…¥å£æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ socket/            # Socket å¤„ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ handlers.ts    # ä¿¡ä»¤å¤„ç†å™¨
â”‚   â”‚   â”‚   â””â”€â”€ rooms.ts       # æˆ¿é—´ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ types/             # ç±»å‹å®šä¹‰
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”‚
â”œâ”€â”€ shared/                    # å…±äº«ä»£ç 
â”‚   â””â”€â”€ types/                 # å…±äº«ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ room.ts
â”‚       â”œâ”€â”€ message.ts
â”‚       â””â”€â”€ signal.ts
â”‚
â”œâ”€â”€ docker/                    # Docker é…ç½®
â”‚   â”œâ”€â”€ Dockerfile.client
â”‚   â”œâ”€â”€ Dockerfile.server
â”‚   â””â”€â”€ coturn/
â”‚       â””â”€â”€ turnserver.conf
â”‚
â”œâ”€â”€ docker-compose.yml         # Docker Compose é…ç½®
â”œâ”€â”€ docker-compose.dev.yml     # å¼€å‘ç¯å¢ƒé…ç½®
â”œâ”€â”€ package.json               # æ ¹ç›®å½• package.json
â”œâ”€â”€ turbo.json                 # Turborepo é…ç½®
â””â”€â”€ README.md
```

---

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **Node.js 20+** (æ¨èä½¿ç”¨ nvm ç®¡ç†)
- **npm** æˆ– **pnpm**
- **Windows / macOS / Linux** å‡å¯

### ğŸš€ ä¸€é”®åˆå§‹åŒ–é¡¹ç›®ï¼ˆå¤åˆ¶å³ç”¨ï¼‰

**Windows PowerShell:**

```powershell
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir p2p-chat
cd p2p-chat

# åˆ›å»ºå‰ç«¯é¡¹ç›® (Vue 3 + TypeScript)
npm create vite@latest client -- --template vue-ts
cd client
npm install vue-router@4 pinia socket.io-client simple-peer
npm install -D unocss @unocss/preset-uno @types/simple-peer
cd ..

# åˆ›å»ºåç«¯é¡¹ç›®
mkdir server
cd server
npm init -y
npm install express socket.io cors
npm install -D typescript @types/node @types/express ts-node nodemon
npx tsc --init
cd ..

# åˆ›å»ºå…±äº«ç±»å‹ç›®å½•
mkdir shared
```

**macOS / Linux:**

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir p2p-chat && cd p2p-chat

# åˆ›å»ºå‰ç«¯é¡¹ç›® (Vue 3 + TypeScript)
npm create vite@latest client -- --template vue-ts
cd client && npm install vue-router@4 pinia socket.io-client simple-peer
npm install -D unocss @unocss/preset-uno @types/simple-peer && cd ..

# åˆ›å»ºåç«¯é¡¹ç›®
mkdir server && cd server
npm init -y
npm install express socket.io cors
npm install -D typescript @types/node @types/express ts-node nodemon
npx tsc --init && cd ..

# åˆ›å»ºå…±äº«ç±»å‹ç›®å½•
mkdir shared
```

### å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
# ç»ˆç«¯1: å¯åŠ¨åç«¯
cd server
npm run dev

# ç»ˆç«¯2: å¯åŠ¨å‰ç«¯
cd client
npm run dev

# å‰ç«¯: http://localhost:5173
# åç«¯: http://localhost:3001
```

### ä¸€é”® Docker éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰

```bash
# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
docker-compose up -d

# è®¿é—®: http://localhost
```

---

## è¯¦ç»†å®ç°æŒ‡å—

### ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–é¡¹ç›®

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir p2p-chat && cd p2p-chat

# åˆå§‹åŒ– monorepo
npm init -y

# åˆ›å»ºå­é¡¹ç›®
mkdir client server shared

# å®‰è£… Turborepo (å¯é€‰ï¼Œç”¨äº monorepo ç®¡ç†)
npm install turbo --save-dev
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå‰ç«¯é¡¹ç›® (Vue 3)

```bash
cd client
npm create vite@latest . -- --template vue-ts

# å®‰è£…æ ¸å¿ƒä¾èµ–
npm install vue-router@4 pinia socket.io-client simple-peer

# å®‰è£… UnoCSS
npm install -D unocss @unocss/preset-uno @unocss/preset-attributify @unocss/transformer-directives

# å®‰è£…ç±»å‹å®šä¹‰
npm install -D @types/simple-peer

# (å¯é€‰) å®‰è£… Naive UI ç»„ä»¶åº“
npm install naive-ui
```

**é…ç½® UnoCSS** - åˆ›å»º `uno.config.ts`:

```typescript
import { defineConfig, presetUno, presetAttributify } from 'unocss'
import transformerDirectives from '@unocss/transformer-directives'

export default defineConfig({
  presets: [
    presetUno(),
    presetAttributify(),
  ],
  transformers: [
    transformerDirectives(),
  ],
  shortcuts: {
    'btn': 'px-4 py-2 rounded-lg cursor-pointer transition-all duration-200',
    'btn-primary': 'btn bg-blue-500 text-white hover:bg-blue-600',
    'btn-danger': 'btn bg-red-500 text-white hover:bg-red-600',
    'card': 'bg-white rounded-xl shadow-lg p-4',
  },
})
```

**é…ç½® Vite** - æ›´æ–° `vite.config.ts`:

```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import UnoCSS from 'unocss/vite'

export default defineConfig({
  plugins: [
    vue(),
    UnoCSS(),
  ],
  server: {
    port: 5173,
    proxy: {
      '/socket.io': {
        target: 'http://localhost:3001',
        ws: true,
      },
    },
  },
})
```

### ç¬¬ä¸‰æ­¥ï¼šå®ç° WebRTC ç»„åˆå¼å‡½æ•° (Composable)

åˆ›å»º `client/src/composables/useWebRTC.ts`:

```typescript
import { ref, onUnmounted, watch } from 'vue'
import Peer, { Instance as PeerInstance } from 'simple-peer'
import { useSocketStore } from '@/stores/socket'

interface PeerData {
  peerId: string
  peer: PeerInstance
  stream: MediaStream | null
  nickname: string
}

// ICE æœåŠ¡å™¨é…ç½®
const iceServers = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    // è‡ªå»º TURN æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
    // {
    //   urls: 'turn:your-server.com:3478',
    //   username: 'user',
    //   credential: 'password',
    // },
  ],
}

export function useWebRTC(roomId: string, localStream: Ref<MediaStream | null>) {
  const socketStore = useSocketStore()
  const peers = ref<Map<string, PeerData>>(new Map())

  // åˆ›å»ºæ–°çš„ Peer è¿æ¥
  const createPeer = (targetId: string, initiator: boolean, nickname = 'æœªçŸ¥ç”¨æˆ·'): PeerInstance => {
    const peer = new Peer({
      initiator,
      trickle: true,
      stream: localStream.value || undefined,
      config: iceServers,
    })

    // ä¿¡ä»¤æ•°æ®
    peer.on('signal', (signal) => {
      socketStore.socket?.emit('signal', {
        type: initiator ? 'offer' : 'answer',
        to: targetId,
        roomId,
        payload: signal,
      })
    })

    // æ¥æ”¶åˆ°è¿œç¨‹æµ
    peer.on('stream', (remoteStream) => {
      const peerData = peers.value.get(targetId)
      if (peerData) {
        peerData.stream = remoteStream
        peers.value = new Map(peers.value)
      }
    })

    // è¿æ¥å…³é—­
    peer.on('close', () => {
      removePeer(targetId)
    })

    // é”™è¯¯å¤„ç†
    peer.on('error', (err) => {
      console.error('Peer error:', err)
      removePeer(targetId)
    })

    return peer
  }

  // æ·»åŠ  Peer
  const addPeer = (peerId: string, initiator: boolean, nickname = 'æœªçŸ¥ç”¨æˆ·') => {
    if (peers.value.has(peerId)) return

    const peer = createPeer(peerId, initiator, nickname)
    const peerData: PeerData = { peerId, peer, stream: null, nickname }
    
    peers.value.set(peerId, peerData)
    peers.value = new Map(peers.value) // è§¦å‘å“åº”å¼æ›´æ–°
  }

  // ç§»é™¤ Peer
  const removePeer = (peerId: string) => {
    const peerData = peers.value.get(peerId)
    if (peerData) {
      peerData.peer.destroy()
      peers.value.delete(peerId)
      peers.value = new Map(peers.value)
    }
  }

  // ç›‘å¬ Socket äº‹ä»¶
  const setupSocketListeners = () => {
    const socket = socketStore.socket
    if (!socket) return

    // æ–°ç”¨æˆ·åŠ å…¥
    socket.on('user-joined', ({ userId, userInfo }) => {
      console.log('User joined:', userId)
      addPeer(userId, true, userInfo?.nickname)
    })

    // ç”¨æˆ·ç¦»å¼€
    socket.on('user-left', ({ userId }) => {
      console.log('User left:', userId)
      removePeer(userId)
    })

    // æ”¶åˆ°ä¿¡ä»¤
    socket.on('signal', ({ from, payload, type }) => {
      let peerData = peers.value.get(from)
      
      if (!peerData && type === 'offer') {
        addPeer(from, false)
        peerData = peers.value.get(from)
      }

      if (peerData) {
        peerData.peer.signal(payload)
      }
    })

    // è·å–æˆ¿é—´ç°æœ‰ç”¨æˆ·
    socket.on('room-users', ({ users }) => {
      users.forEach((userId: string) => {
        if (userId !== socket.id) {
          addPeer(userId, true)
        }
      })
    })
  }

  // æ¸…ç† Socket ç›‘å¬å™¨
  const cleanupSocketListeners = () => {
    const socket = socketStore.socket
    if (!socket) return
    
    socket.off('user-joined')
    socket.off('user-left')
    socket.off('signal')
    socket.off('room-users')
  }

  // ç›‘å¬ socket è¿æ¥çŠ¶æ€
  watch(() => socketStore.isConnected, (connected) => {
    if (connected) {
      setupSocketListeners()
    }
  }, { immediate: true })

  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†
  onUnmounted(() => {
    cleanupSocketListeners()
    peers.value.forEach((peerData) => {
      peerData.peer.destroy()
    })
    peers.value.clear()
  })

  return {
    peers,
    addPeer,
    removePeer,
  }
}
```

### ç¬¬å››æ­¥ï¼šå®ç° Socket Store (Pinia)

åˆ›å»º `client/src/stores/socket.ts`:

```typescript
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { io, Socket } from 'socket.io-client'

const SOCKET_URL = import.meta.env.VITE_SOCKET_URL || 'http://localhost:3001'

export const useSocketStore = defineStore('socket', () => {
  // çŠ¶æ€
  const socket = ref<Socket | null>(null)
  const isConnected = ref(false)
  const socketId = ref<string | null>(null)

  // è®¡ç®—å±æ€§
  const connectionStatus = computed(() => 
    isConnected.value ? 'å·²è¿æ¥' : 'æœªè¿æ¥'
  )

  // è¿æ¥
  const connect = () => {
    if (socket.value?.connected) return

    socket.value = io(SOCKET_URL, {
      transports: ['websocket'],
      autoConnect: true,
    })

    socket.value.on('connect', () => {
      isConnected.value = true
      socketId.value = socket.value?.id || null
      console.log('âœ… Socket connected:', socketId.value)
    })

    socket.value.on('disconnect', () => {
      isConnected.value = false
      socketId.value = null
      console.log('âŒ Socket disconnected')
    })

    socket.value.on('connect_error', (error) => {
      console.error('Socket connection error:', error)
    })
  }

  // æ–­å¼€è¿æ¥
  const disconnect = () => {
    if (socket.value) {
      socket.value.disconnect()
      socket.value = null
      isConnected.value = false
      socketId.value = null
    }
  }

  // å‘é€æ¶ˆæ¯
  const emit = (event: string, data: any) => {
    if (socket.value?.connected) {
      socket.value.emit(event, data)
    } else {
      console.warn('Socket not connected, cannot emit:', event)
    }
  }

  return {
    socket,
    isConnected,
    socketId,
    connectionStatus,
    connect,
    disconnect,
    emit,
  }
})
```

### ç¬¬äº”æ­¥ï¼šå®ç°åª’ä½“æµ Composable

åˆ›å»º `client/src/composables/useMediaStream.ts`:

```typescript
import { ref, onUnmounted } from 'vue'

export function useMediaStream() {
  // å“åº”å¼çŠ¶æ€
  const stream = ref<MediaStream | null>(null)
  const isAudioEnabled = ref(true)
  const isVideoEnabled = ref(true)
  const error = ref<string | null>(null)

  // è·å–åª’ä½“æµ
  const startMedia = async (video = true, audio = true) => {
    try {
      const mediaStream = await navigator.mediaDevices.getUserMedia({
        video: video ? {
          width: { ideal: 1280 },
          height: { ideal: 720 },
          facingMode: 'user',
        } : false,
        audio: audio ? {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true,
        } : false,
      })

      stream.value = mediaStream
      isAudioEnabled.value = audio
      isVideoEnabled.value = video
      error.value = null

      return mediaStream
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'æ— æ³•è®¿é—®åª’ä½“è®¾å¤‡'
      throw err
    }
  }

  // åœæ­¢åª’ä½“æµ
  const stopMedia = () => {
    if (stream.value) {
      stream.value.getTracks().forEach((track) => track.stop())
      stream.value = null
      isAudioEnabled.value = false
      isVideoEnabled.value = false
      error.value = null
    }
  }

  // åˆ‡æ¢éŸ³é¢‘
  const toggleAudio = () => {
    if (stream.value) {
      const audioTracks = stream.value.getAudioTracks()
      audioTracks.forEach((track) => {
        track.enabled = !track.enabled
      })
      isAudioEnabled.value = !isAudioEnabled.value
    }
  }

  // åˆ‡æ¢è§†é¢‘
  const toggleVideo = () => {
    if (stream.value) {
      const videoTracks = stream.value.getVideoTracks()
      videoTracks.forEach((track) => {
        track.enabled = !track.enabled
      })
      isVideoEnabled.value = !isVideoEnabled.value
    }
  }

  // åˆ‡æ¢æ‘„åƒå¤´ï¼ˆå‰ç½®/åç½®ï¼‰
  const switchCamera = async () => {
    if (!stream.value) return

    const videoTrack = stream.value.getVideoTracks()[0]
    if (!videoTrack) return

    const currentFacing = videoTrack.getSettings().facingMode
    const newFacing = currentFacing === 'user' ? 'environment' : 'user'

    try {
      const newStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: newFacing },
        audio: isAudioEnabled.value,
      })

      // åœæ­¢æ—§è½¨é“
      videoTrack.stop()
      
      // æ›¿æ¢è§†é¢‘è½¨é“
      const newVideoTrack = newStream.getVideoTracks()[0]
      stream.value.removeTrack(videoTrack)
      stream.value.addTrack(newVideoTrack)
    } catch (err) {
      console.error('Failed to switch camera:', err)
    }
  }

  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†
  onUnmounted(() => {
    stopMedia()
  })

  return {
    stream,
    isAudioEnabled,
    isVideoEnabled,
    error,
    startMedia,
    stopMedia,
    toggleAudio,
    toggleVideo,
    switchCamera,
  }
}
```

### ç¬¬å…­æ­¥ï¼šå®ç°åç«¯ä¿¡ä»¤æœåŠ¡å™¨

åˆ›å»º `server/src/index.ts`:

```typescript
import express from 'express';
import { createServer } from 'http';
import { Server, Socket } from 'socket.io';
import cors from 'cors';

const app = express();
const httpServer = createServer(app);

const io = new Server(httpServer, {
  cors: {
    origin: process.env.CLIENT_URL || 'http://localhost:5173',
    methods: ['GET', 'POST'],
  },
});

// æˆ¿é—´ç®¡ç†
interface Room {
  id: string;
  name: string;
  users: Map<string, UserInfo>;
  createdAt: Date;
}

interface UserInfo {
  id: string;
  nickname: string;
  joinedAt: Date;
}

const rooms = new Map<string, Room>();

// ç”Ÿæˆæˆ¿é—´ID
function generateRoomId(): string {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

io.on('connection', (socket: Socket) => {
  console.log('User connected:', socket.id);

  // åˆ›å»ºæˆ¿é—´
  socket.on('create-room', ({ name, nickname }, callback) => {
    const roomId = generateRoomId();
    const room: Room = {
      id: roomId,
      name: name || `æˆ¿é—´ ${roomId}`,
      users: new Map(),
      createdAt: new Date(),
    };
    
    rooms.set(roomId, room);
    
    callback({ success: true, roomId });
    console.log(`Room created: ${roomId}`);
  });

  // åŠ å…¥æˆ¿é—´
  socket.on('join-room', ({ roomId, nickname }, callback) => {
    const room = rooms.get(roomId);
    
    if (!room) {
      callback({ success: false, error: 'æˆ¿é—´ä¸å­˜åœ¨' });
      return;
    }

    // åŠ å…¥ Socket.io æˆ¿é—´
    socket.join(roomId);
    
    // æ·»åŠ ç”¨æˆ·åˆ°æˆ¿é—´
    const userInfo: UserInfo = {
      id: socket.id,
      nickname: nickname || `ç”¨æˆ·${socket.id.slice(0, 4)}`,
      joinedAt: new Date(),
    };
    room.users.set(socket.id, userInfo);

    // è·å–æˆ¿é—´å†…å…¶ä»–ç”¨æˆ·
    const existingUsers = Array.from(room.users.keys()).filter(
      (id) => id !== socket.id
    );

    // é€šçŸ¥æˆ¿é—´å†…å…¶ä»–ç”¨æˆ·
    socket.to(roomId).emit('user-joined', {
      userId: socket.id,
      userInfo,
    });

    callback({
      success: true,
      roomInfo: {
        id: room.id,
        name: room.name,
        userCount: room.users.size,
      },
    });

    // å‘é€ç°æœ‰ç”¨æˆ·åˆ—è¡¨
    socket.emit('room-users', { users: existingUsers });
    
    console.log(`User ${socket.id} joined room ${roomId}`);
  });

  // ç¦»å¼€æˆ¿é—´
  socket.on('leave-room', ({ roomId }) => {
    leaveRoom(socket, roomId);
  });

  // è½¬å‘ä¿¡ä»¤
  socket.on('signal', ({ to, roomId, type, payload }) => {
    io.to(to).emit('signal', {
      from: socket.id,
      type,
      payload,
    });
  });

  // èŠå¤©æ¶ˆæ¯
  socket.on('chat-message', ({ roomId, message }) => {
    const room = rooms.get(roomId);
    if (!room) return;

    const userInfo = room.users.get(socket.id);
    
    socket.to(roomId).emit('chat-message', {
      from: socket.id,
      nickname: userInfo?.nickname || 'æœªçŸ¥ç”¨æˆ·',
      message,
      timestamp: Date.now(),
    });
  });

  // åª’ä½“çŠ¶æ€å˜æ›´
  socket.on('media-state', ({ roomId, isAudioEnabled, isVideoEnabled }) => {
    socket.to(roomId).emit('user-media-state', {
      userId: socket.id,
      isAudioEnabled,
      isVideoEnabled,
    });
  });

  // æ–­å¼€è¿æ¥
  socket.on('disconnect', () => {
    // ä»æ‰€æœ‰æˆ¿é—´ç§»é™¤ç”¨æˆ·
    rooms.forEach((room, roomId) => {
      if (room.users.has(socket.id)) {
        leaveRoom(socket, roomId);
      }
    });
    console.log('User disconnected:', socket.id);
  });
});

// ç¦»å¼€æˆ¿é—´çš„é€šç”¨å‡½æ•°
function leaveRoom(socket: Socket, roomId: string) {
  const room = rooms.get(roomId);
  if (!room) return;

  room.users.delete(socket.id);
  socket.leave(roomId);
  
  // é€šçŸ¥å…¶ä»–ç”¨æˆ·
  socket.to(roomId).emit('user-left', { userId: socket.id });

  // å¦‚æœæˆ¿é—´ä¸ºç©ºï¼Œåˆ é™¤æˆ¿é—´
  if (room.users.size === 0) {
    rooms.delete(roomId);
    console.log(`Room ${roomId} deleted (empty)`);
  }
  
  console.log(`User ${socket.id} left room ${roomId}`);
}

// å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
  res.json({ status: 'ok', rooms: rooms.size });
});

// è·å–æˆ¿é—´ä¿¡æ¯ (å¯é€‰ API)
app.get('/api/room/:roomId', (req, res) => {
  const room = rooms.get(req.params.roomId);
  if (!room) {
    res.status(404).json({ error: 'æˆ¿é—´ä¸å­˜åœ¨' });
    return;
  }
  res.json({
    id: room.id,
    name: room.name,
    userCount: room.users.size,
    createdAt: room.createdAt,
  });
});

const PORT = process.env.PORT || 3001;

httpServer.listen(PORT, () => {
  console.log(`ğŸš€ Signal server running on port ${PORT}`);
});
```

### ç¬¬ä¸ƒæ­¥ï¼šåˆ›å»ºè§†é¢‘ç½‘æ ¼ç»„ä»¶ (Vue 3)

åˆ›å»º `client/src/components/video/VideoTile.vue`:

```vue
<script setup lang="ts">
import { ref, watch, onMounted } from 'vue'

interface Props {
  stream: MediaStream | null
  muted?: boolean
  nickname: string
  isLocal?: boolean
  isAudioEnabled?: boolean
  isVideoEnabled?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  muted: false,
  isLocal: false,
  isAudioEnabled: true,
  isVideoEnabled: true,
})

const videoRef = ref<HTMLVideoElement | null>(null)

// ç›‘å¬ stream å˜åŒ–
watch(() => props.stream, (newStream) => {
  if (videoRef.value && newStream) {
    videoRef.value.srcObject = newStream
  }
}, { immediate: true })

onMounted(() => {
  if (videoRef.value && props.stream) {
    videoRef.value.srcObject = props.stream
  }
})
</script>

<template>
  <div class="relative bg-gray-900 rounded-xl overflow-hidden aspect-video shadow-lg">
    <!-- è§†é¢‘å…ƒç´  -->
    <video
      ref="videoRef"
      autoplay
      playsinline
      :muted="muted"
      class="w-full h-full object-cover"
      :class="{ 'scale-x-[-1]': isLocal }"
    />
    
    <!-- è§†é¢‘å…³é—­æ—¶çš„å ä½ -->
    <div
      v-if="!isVideoEnabled"
      class="absolute inset-0 flex items-center justify-center bg-gray-800"
    >
      <div class="w-20 h-20 rounded-full bg-gray-600 flex items-center justify-center">
        <span class="text-2xl text-white">{{ nickname.charAt(0).toUpperCase() }}</span>
      </div>
    </div>
    
    <!-- åº•éƒ¨ä¿¡æ¯æ  -->
    <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black/70 to-transparent">
      <div class="flex items-center justify-between">
        <span class="text-white text-sm font-medium">
          {{ nickname }}
          <span v-if="isLocal" class="text-blue-400">(ä½ )</span>
        </span>
        <div class="flex items-center gap-2">
          <!-- é™éŸ³å›¾æ ‡ -->
          <span v-if="!isAudioEnabled" class="text-red-500">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </span>
        </div>
      </div>
    </div>
  </div>
</template>
```

åˆ›å»º `client/src/components/video/VideoGrid.vue`:

```vue
<script setup lang="ts">
import { computed } from 'vue'
import VideoTile from './VideoTile.vue'

interface PeerData {
  stream: MediaStream | null
  nickname: string
  isAudioEnabled?: boolean
  isVideoEnabled?: boolean
}

interface Props {
  localStream: MediaStream | null
  localNickname: string
  peers: Map<string, PeerData>
  isAudioEnabled?: boolean
  isVideoEnabled?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  isAudioEnabled: true,
  isVideoEnabled: true,
})

// è®¡ç®—æ€»äººæ•°
const totalCount = computed(() => props.peers.size + 1)

// æ ¹æ®äººæ•°è®¡ç®—ç½‘æ ¼å¸ƒå±€
const gridClass = computed(() => {
  const count = totalCount.value
  if (count <= 1) return 'grid-cols-1'
  if (count <= 2) return 'grid-cols-1 md:grid-cols-2'
  if (count <= 4) return 'grid-cols-2'
  if (count <= 6) return 'grid-cols-2 md:grid-cols-3'
  if (count <= 9) return 'grid-cols-3'
  return 'grid-cols-3 md:grid-cols-4'
})

// è½¬æ¢ peers Map ä¸ºæ•°ç»„
const peersArray = computed(() => Array.from(props.peers.entries()))
</script>

<template>
  <div class="h-full p-4 bg-gray-950">
    <div :class="['grid gap-4 h-full auto-rows-fr', gridClass]">
      <!-- æœ¬åœ°è§†é¢‘ -->
      <VideoTile
        :stream="localStream"
        :muted="true"
        :nickname="localNickname"
        :is-local="true"
        :is-audio-enabled="isAudioEnabled"
        :is-video-enabled="isVideoEnabled"
      />
      
      <!-- è¿œç¨‹è§†é¢‘ -->
      <VideoTile
        v-for="[peerId, peerData] in peersArray"
        :key="peerId"
        :stream="peerData.stream"
        :nickname="peerData.nickname"
        :is-audio-enabled="peerData.isAudioEnabled ?? true"
        :is-video-enabled="peerData.isVideoEnabled ?? true"
      />
    </div>
  </div>
</template>
```

åˆ›å»º `client/src/components/video/Controls.vue`:

```vue
<script setup lang="ts">
interface Props {
  isAudioEnabled: boolean
  isVideoEnabled: boolean
  isScreenSharing?: boolean
}

const props = withDefaults(defineProps<Props>(), {
  isScreenSharing: false,
})

const emit = defineEmits<{
  toggleAudio: []
  toggleVideo: []
  toggleScreenShare: []
  leaveRoom: []
}>()
</script>

<template>
  <div class="flex items-center justify-center gap-4 p-4 bg-gray-900/90 backdrop-blur">
    <!-- éº¦å…‹é£æŒ‰é’® -->
    <button
      @click="emit('toggleAudio')"
      :class="[
        'w-12 h-12 rounded-full flex items-center justify-center transition-all',
        isAudioEnabled 
          ? 'bg-gray-700 hover:bg-gray-600 text-white' 
          : 'bg-red-500 hover:bg-red-600 text-white'
      ]"
      :title="isAudioEnabled ? 'å…³é—­éº¦å…‹é£' : 'å¼€å¯éº¦å…‹é£'"
    >
      <svg v-if="isAudioEnabled" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
      </svg>
      <svg v-else class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </button>

    <!-- æ‘„åƒå¤´æŒ‰é’® -->
    <button
      @click="emit('toggleVideo')"
      :class="[
        'w-12 h-12 rounded-full flex items-center justify-center transition-all',
        isVideoEnabled 
          ? 'bg-gray-700 hover:bg-gray-600 text-white' 
          : 'bg-red-500 hover:bg-red-600 text-white'
      ]"
      :title="isVideoEnabled ? 'å…³é—­æ‘„åƒå¤´' : 'å¼€å¯æ‘„åƒå¤´'"
    >
      <svg v-if="isVideoEnabled" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
      </svg>
      <svg v-else class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd" />
        <path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z" />
      </svg>
    </button>

    <!-- å±å¹•å…±äº«æŒ‰é’® -->
    <button
      @click="emit('toggleScreenShare')"
      :class="[
        'w-12 h-12 rounded-full flex items-center justify-center transition-all',
        isScreenSharing 
          ? 'bg-green-500 hover:bg-green-600 text-white' 
          : 'bg-gray-700 hover:bg-gray-600 text-white'
      ]"
      title="å±å¹•å…±äº«"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
      </svg>
    </button>

    <!-- ç¦»å¼€æŒ‰é’® -->
    <button
      @click="emit('leaveRoom')"
      class="w-12 h-12 rounded-full bg-red-600 hover:bg-red-700 text-white flex items-center justify-center transition-all"
      title="ç¦»å¼€æˆ¿é—´"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z" />
      </svg>
    </button>
  </div>
</template>
```
```

---

## éƒ¨ç½²æ–¹æ¡ˆ

### Docker Compose éƒ¨ç½²

åˆ›å»º `docker-compose.yml`:

```yaml
version: '3.8'

services:
  # å‰ç«¯æœåŠ¡
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - server
    environment:
      - VITE_SOCKET_URL=https://your-domain.com

  # ä¿¡ä»¤æœåŠ¡å™¨
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - CLIENT_URL=https://your-domain.com

  # TURN/STUN æœåŠ¡å™¨
  coturn:
    image: coturn/coturn:latest
    network_mode: host
    volumes:
      - ./docker/coturn/turnserver.conf:/etc/coturn/turnserver.conf
    restart: unless-stopped
```

### coturn é…ç½®

åˆ›å»º `docker/coturn/turnserver.conf`:

```ini
# åŸºç¡€é…ç½®
listening-port=3478
tls-listening-port=5349
external-ip=YOUR_PUBLIC_IP

# è®¤è¯
lt-cred-mech
user=webrtc:your_secure_password
realm=your-domain.com

# æ—¥å¿—
verbose
log-file=/var/log/turnserver.log

# å®‰å…¨
no-multicast-peers
no-cli
fingerprint

# ç«¯å£èŒƒå›´
min-port=49152
max-port=65535
```

### Nginx é…ç½®

```nginx
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/p2p-chat;
        try_files $uri $uri/ /index.html;
    }

    # ä¿¡ä»¤æœåŠ¡å™¨
    location /socket.io/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400;
    }
}
```

---

## ä¸€é”®éƒ¨ç½²è„šæœ¬

åˆ›å»º `deploy.sh`:

```bash
#!/bin/bash

set -e

echo "========================================="
echo "  P2P Chat ä¸€é”®éƒ¨ç½²è„šæœ¬"
echo "========================================="

# æ£€æŸ¥ Docker
if ! command -v docker &> /dev/null; then
    echo "æ­£åœ¨å®‰è£… Docker..."
    curl -fsSL https://get.docker.com | sh
fi

# æ£€æŸ¥ docker-compose
if ! command -v docker-compose &> /dev/null; then
    echo "æ­£åœ¨å®‰è£… docker-compose..."
    curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
fi

# è·å–å…¬ç½‘ IP
PUBLIC_IP=$(curl -s ifconfig.me)
echo "æ£€æµ‹åˆ°å…¬ç½‘ IP: $PUBLIC_IP"

# æ›´æ–° coturn é…ç½®
sed -i "s/YOUR_PUBLIC_IP/$PUBLIC_IP/g" docker/coturn/turnserver.conf

# æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build

echo "========================================="
echo "  éƒ¨ç½²å®Œæˆï¼"
echo "  è®¿é—®: http://$PUBLIC_IP"
echo "========================================="
```

---

## åŠŸèƒ½æ‰©å±•è·¯çº¿å›¾

### Phase 1 - MVP (1-2å‘¨)
- [x] åŸºç¡€æˆ¿é—´åˆ›å»º/åŠ å…¥
- [x] æ–‡å­—èŠå¤©
- [x] 1å¯¹1è§†é¢‘é€šè¯
- [x] ç¾¤ç»„è§†é¢‘ (Mesh)

### Phase 2 - å¢å¼ºåŠŸèƒ½ (2-3å‘¨)
- [ ] å±å¹•å…±äº«
- [ ] æ–‡ä»¶ä¼ è¾“ (é€šè¿‡ DataChannel)
- [ ] èŠå¤©æ¶ˆæ¯å†å² (æœ¬åœ°å­˜å‚¨)
- [ ] æˆ¿é—´å¯†ç ä¿æŠ¤
- [ ] ç§»åŠ¨ç«¯é€‚é…

### Phase 3 - é«˜çº§åŠŸèƒ½ (3-4å‘¨)
- [ ] SFU æ¨¡å¼ (æ”¯æŒå¤§å‹ç¾¤ç»„)
- [ ] å½•åˆ¶åŠŸèƒ½
- [ ] è™šæ‹ŸèƒŒæ™¯
- [ ] å™ªéŸ³æ¶ˆé™¤å¢å¼º
- [ ] å¤šè¯­è¨€æ”¯æŒ

---

## å‚è€ƒèµ„æº

| èµ„æº | é“¾æ¥ |
|------|------|
| WebRTC API | https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API |
| simple-peer | https://github.com/feross/simple-peer |
| Socket.io | https://socket.io/docs/v4/ |
| coturn | https://github.com/coturn/coturn |

---

## æ€»ç»“

### æŠ€æœ¯æ ˆæ€»è§ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|---------|------|
| **å‰ç«¯æ¡†æ¶** | Vue 3 + TypeScript | Composition APIï¼Œå“åº”å¼å¼ºå¤§ |
| **æ„å»ºå·¥å…·** | Vite | æé€Ÿ HMRï¼ŒVue å®˜æ–¹æ¨è |
| **çŠ¶æ€ç®¡ç†** | Pinia | Vue å®˜æ–¹ï¼Œæ›¿ä»£ Vuex |
| **æ ·å¼æ–¹æ¡ˆ** | UnoCSS | åŸå­åŒ– CSSï¼Œæ¯” Tailwind æ›´å¿« |
| **åç«¯æ¡†æ¶** | Express + Socket.io | è½»é‡ä¿¡ä»¤æœåŠ¡å™¨ |
| **P2P é€šä¿¡** | WebRTC + simple-peer | æµè§ˆå™¨åŸç”Ÿæ”¯æŒ |
| **éƒ¨ç½²æ–¹æ¡ˆ** | Docker + Nginx | å®¹å™¨åŒ–ä¸€é”®éƒ¨ç½² |

### æ ¸å¿ƒä¼˜åŠ¿

1. **ğŸ”’ çœŸæ­£çš„ P2P** - æ•°æ®ä¸ç»è¿‡æœåŠ¡å™¨ï¼Œéšç§æ€§å¥½
2. **âš¡ è½»é‡éƒ¨ç½²** - ä¿¡ä»¤æœåŠ¡å™¨èµ„æºå ç”¨æä½
3. **ğŸŒ æŠ€æœ¯æˆç†Ÿ** - åŸºäº WebRTC æ ‡å‡†ï¼Œæµè§ˆå™¨åŸç”Ÿæ”¯æŒ
4. **ğŸ§© æ˜“äºæ‰©å±•** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ–¹ä¾¿æ·»åŠ æ–°åŠŸèƒ½
5. **ğŸ‡¨ğŸ‡³ ä¸­æ–‡å‹å¥½** - Vue3 ä¸­æ–‡ç”Ÿæ€å®Œå–„ï¼Œæ–‡æ¡£é½å…¨

### å¼€å‘å‘¨æœŸé¢„ä¼°

| ç‰ˆæœ¬ | åŠŸèƒ½èŒƒå›´ | é¢„ä¼°æ—¶é—´ |
|------|---------|---------|
| **æç®€ç‰ˆ** | 1å¯¹1è§†é¢‘ + æ–‡å­—èŠå¤© | 3-4 å°æ—¶ |
| **MVPç‰ˆ** | ç¾¤èŠ + ç¾¤è§†é¢‘ (â‰¤6äºº) | 1-2 å¤© |
| **å®Œæ•´ç‰ˆ** | æ‰€æœ‰åŠŸèƒ½ + ä¼˜åŒ– | 1-2 å‘¨ |

---

> ğŸ“ **ä¸‹ä¸€æ­¥**ï¼šè¿è¡Œä¸Šé¢çš„åˆå§‹åŒ–å‘½ä»¤åˆ›å»ºç©ºé¡¹ç›®ï¼Œç„¶åæˆ‘å¯ä»¥å¸®ä½ é€æ­¥å®ç°æ¯ä¸ªæ¨¡å—çš„ä»£ç ï¼

